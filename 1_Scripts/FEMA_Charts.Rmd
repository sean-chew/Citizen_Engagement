---
title: "FEMA_Charts"
author: "Sean"
date: '2022-08-29'
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    df_print: paged
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
### Set Environment ------------------------------------------------------------
# Clear the environment
rm(list=ls())
gc()
# So the code will compile warnings as per usual
options(warn = 0)
# Turn off scientific notation
options(scipen = 999)
### Load Packages --------------------------------------------------------------
if(!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr, magrittr, stringr, reshape2, janitor,
lubridate, readxl, data.table, ggplot2, scales, readr,
tidyr, zoo, skimr, openxlsx,ggspatial, rgeos, data.table,RColorBrewer,
tidyverse, rio, collapse, sf, glue, XML, tm, here, purrr, repurrrsive,
tmap,tidygraph, nabor,igraph, viridis, hrbrthemes,RSocrata,soql,xts,
tidycensus,tmaptools, eks, leaflet, maps, rosm)
```

# Investigation of 311 Complaints and FEMA Assistance Data:
## Purpose:
The purpose of this analysis will be to:

1. See how extreme storms contribute to changes in 311 complaints

2. Then, see if they are collocated with several pieces of information:

+ Stormwater flooding
+ Location of FEMA grants during disasters

## I) Analyze NYCEM recommended complaints
In this section, I want to read in the shapefiles and analyze them to see what exactly they're representing.

### a) Read in Data
* Here is a description of each shapefile:
    + **NYCEM_Spatial** contains 311 complaints from: "Mold","MOLD","Electric","ELECTRIC","Electrical","Indoor Sewage","Plumbing","PLUMBING","FLOORING/STAIRS","WATER LEAK"
    + **DEP_points** were the 311 compmlaints from Department of Environmental Protection pulled previously.
    + **extreme flood** is a shapefile that is a projections of severe flooding scenarios in NYC.
    + **NYC_FEMA_damage_Spatial** is a shapefile I created from the dataset that shows FEMA grants during disasters, which is reported at the zip code level at its most granular in order to protect people's privac, as downloaded here: https://www.fema.gov/openfema-data-page/individuals-and-households-program-valid-registrations-v1. One important thing to note is that it provides information on the applications for assistance during the storms, and *whether or not the household was able to get the assistance*. I will be using this in the analysis to show whether or not households got the help they needed.  

```{r, include = TRUE}
NYCEM_spatial <- readRDS("./3_Intermediate/NYCEM_spatial.RDS") 
DEP_points <- read_rds("./3_Intermediate/DEP_points.rds")
boroughs <- read_sf("./2_Data/borough_boundaries/geo_export_b5bd9a81-0a45-411a-a23f-8a1983296a03.shp")
tracts <- read_sf("./2_Data/ct_2010/geo_export_1c19ce5f-d77c-4a3f-adbe-7456e4a782a6.shp")
parks <- read_sf("./2_Data/Open Space (Parks)/geo_export_2addf878-38fa-4c00-8396-5aa5bf54644c.shp")
zips<- read_sf("./2_Data/ZIP_CODE_040114/ZIP_CODE_040114.shp")  %>% 
    st_transform(4326)

moderate_flood <- read_sf("./2_Data/moderate_floodmap/moderate_floodmap.shp")%>% 
  st_transform(crs = 4326) %>% 
  filter(Flooding_C == 2) %>%
  st_zm(flood) %>% 
    st_make_valid()

extreme_flood <-read_sf("./2_Data/extreme_floodmap/Extreme_Flood.shp")%>% 
    st_make_valid() %>% 
    st_set_crs(4326)

NYC_FEMA_Spatial <- read_sf("./3_Intermediate/FEMA_Cleaned.shp")
NYC_FEMA_damage_Spatial <- read_sf("./3_Intermediate/FEMA_Cleaned_damage.shp")


source("./1_Scripts/FEMA_Functions.R")
```

```{r}
# https://rspatialdata.github.io/osm.html 
# from rosm package:
nyc_bb <-st_bbox(zips)%>%
  as.matrix() %>%
  matrix(nrow =2, ncol = 2)

nyc_bb_tm <- 
  cbind(nyc_bb[1,],nyc_bb[2,])

osm.types()

NYC_map <- osm.raster(nyc_bb_tm,type = "cartolight")

```

One thing that's interesting is that of the past three storms, the spike in Sandy was the least pronounced, while it becomes more pronounced in 2021 with Henri and Ida.
```{r}
Ida_Sewer <-  DEP_filter(DEP_points,"2021-08-22","2021-9-30") 
Sandy_Sewer <- DEP_filter(DEP_points,"2012-10-01","2012-11-2")
Henri_Sewer <-DEP_filter(DEP_points,"2021-08-15","2021-08-30")

Sandy_timeseries <- time_plotting_series(Sandy_Sewer,"Sandy Timeframe")
Ida_timeseries <- time_plotting_series(Ida_Sewer,"Ida Timeframe")
Henri_timeseries <- time_plotting_series(Henri_Sewer,"Henri Timeframe")

Sandy_timeseries
ggsave("./4_Outputs/1_Flooding/sandy_timeseries.jpeg")

Henri_timeseries
ggsave("./4_Outputs/1_Flooding/henri_timeseries.jpeg")

Ida_timeseries
ggsave("./4_Outputs/1_Flooding/ida_timeseries.jpeg")
```
We can obtain a contour map of the three storms to see where complaints were most concentrated.
```{r}

Ida_sewer_contour <- st_kde(Ida_Sewer) %>% 
    st_get_contour(cont = c(10,20,30,40,50,60,70,80,90,100))

Sandy_sewer_contour <- st_kde(Sandy_Sewer) %>% 
    st_get_contour(cont = c(10,20,30,40,50,60,70,80,90,100))

Henri_sewer_contour <- st_kde(Henri_Sewer) %>% 
    st_get_contour(cont = c(10,20,30,40,50,60,70,80,90,100))

```

Comparing the complaints of Ida
```{r}
ida_contour <- tm_shape(boroughs, unit = "imperial")+
    tm_fill()+
    tm_shape(Ida_sewer_contour,bbox = st_bbox(Ida_sewer_contour))+    
    tm_fill(title = "Percentile","contlabel", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Ida Sewer Complaint Density",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(ida_contour,"./4_Outputs/1_Flooding/ida_contour.jpeg")

ida_damage_pc <- tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Count of Damaged Buildings per Capita","dmgd_d_", 
            palette = "PuBu", lwd = .01,alpha = .5,
            style = "jenks") +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Ida FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(ida_damage_pc,"./4_Outputs/1_Flooding/ida_damage_pc.jpeg")

ida_damage <- tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Count of Damaged Buildings","damgd_d", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Ida FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)
tmap_save(ida_damage,"./4_Outputs/1_Flooding/ida_damage.jpeg")
```
Comparing the complaints of Sandy
```{r}
sandy_contour <- tm_shape(boroughs, unit = "imperial")+
    tm_fill()+
    tm_shape(Sandy_sewer_contour,bbox = st_bbox(Sandy_sewer_contour))+    
    tm_fill(title = "Percentile","contlabel", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Sandy Sewer Complaint Density",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(sandy_contour,"./4_Outputs/1_Flooding/sandy_contour.jpeg")

sandy_damage_pc <-tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Counted Damaged Buildings per Capita","dmgd_s_", 
            palette = "PuBu", lwd = .01,alpha = .5,
            style = "jenks") +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Sandy FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(sandy_damage_pc,"./4_Outputs/1_Flooding/sandy_damage_pc.jpeg")

sandy_damage<- tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Count of Damaged Buildings","dmgd_sn", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Sandy FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(sandy_damage,"./4_Outputs/1_Flooding/sandy_damage.jpeg")

```
