---
title: "FEMA_Charts"
author: "Sean"
date: '2022-08-29'
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    df_print: paged
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
### Set Environment ------------------------------------------------------------
# Clear the environment
#rm(list=ls())
gc()
# So the code will compile warnings as per usual
options(warn = 0)
# Turn off scientific notation
options(scipen = 999)
### Load Packages --------------------------------------------------------------
if(!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr, magrittr, stringr, reshape2, janitor,
lubridate, readxl, data.table, ggplot2, scales, readr,
tidyr, zoo, skimr, openxlsx,ggspatial, rgeos, data.table,RColorBrewer,
tidyverse, rio, collapse, sf, glue, XML, tm, here, purrr, repurrrsive,
tmap,tidygraph, nabor,igraph, viridis, hrbrthemes,RSocrata,soql,xts,
tidycensus,tmaptools, eks, leaflet, maps, rosm, terra,stars,raster,basemaps,maptiles)
```

# Investigation of 311 Complaints and FEMA Assistance Data:
## Purpose:
The purpose of this analysis will be to:

1. See how extreme storms contribute to changes in 311 complaints

2. Then, see if they are collocated with several pieces of information:

+ Stormwater flooding
+ Location of FEMA grants during disasters

## I) Analyze NYCEM recommended complaints
In this section, I want to read in the shapefiles and analyze them to see what exactly they're representing.

### a) Read in Data
* Here is a description of each shapefile:
    + **NYCEM_Spatial** contains 311 complaints from: "Mold","MOLD","Electric","ELECTRIC","Electrical","Indoor Sewage","Plumbing","PLUMBING","FLOORING/STAIRS","WATER LEAK"
    + **DEP_points** were the 311 compmlaints from Department of Environmental Protection pulled previously.
    + **extreme flood** is a shapefile that is a projections of severe flooding scenarios in NYC.
    + **NYC_FEMA_damage_Spatial** is a shapefile I created from the dataset that shows FEMA grants during disasters, which is reported at the zip code level at its most granular in order to protect people's privac, as downloaded here: https://www.fema.gov/openfema-data-page/individuals-and-households-program-valid-registrations-v1. One important thing to note is that it provides information on the applications for assistance during the storms, and *whether or not the household was able to get the assistance*. I will be using this in the analysis to show whether or not households got the help they needed.  

```{r, include = TRUE}
NYCEM_spatial <- readRDS("../3_Intermediate/NYCEM_spatial.RDS") 
DEP_points <- read_rds("../3_Intermediate/DEP_points.rds")
boroughs <- read_sf("../2_Data/borough_boundaries/geo_export_b5bd9a81-0a45-411a-a23f-8a1983296a03.shp")
tracts <- read_sf("../2_Data/ct_2010/geo_export_1c19ce5f-d77c-4a3f-adbe-7456e4a782a6.shp")
parks <- read_sf("../2_Data/Open Space (Parks)/geo_export_2addf878-38fa-4c00-8396-5aa5bf54644c.shp")
zips<- read_sf("../2_Data/ZIP_CODE_040114/ZIP_CODE_040114.shp")  %>% 
    st_transform(2263)
map_pluto <- read_sf("../2_Data/built_env/nyc_mappluto_22v2_shp/MapPLUTO.shp")

moderate_flood <- read_sf("../2_Data/moderate_floodmap/moderate_floodmap.shp")%>% 
  st_transform(crs = 2263) %>% 
  filter(Flooding_C == 2) %>%
  st_zm(flood) %>% 
    st_make_valid()

extreme_flood <-read_sf("../2_Data/extreme_floodmap/Extreme_Flood.shp")%>% 
    st_make_valid() %>% 
    st_set_crs(2263)

NYC_FEMA_Spatial <- read_sf("../3_Intermediate/FEMA_Cleaned.shp")
NYC_FEMA_damage_Spatial <- read_sf("../3_Intermediate/FEMA_Cleaned_damage.shp")


source("../1_Scripts/FEMA_Functions.R")
```

```{r}

# nyc_dissolve<-boroughs %>% 
#     st_union() %>% # unite to a geometry object
#     st_sf()

# set defaults for the basemap
# set_defaults(map_service = "carto", map_type = "dark")
# nyc_raster<-basemap_raster(nyc_dissolve)
# nyc_raster



```

One thing that's interesting is that of the past three storms, the spike in Sandy was the least pronounced, while it becomes more pronounced in 2021 with Henri and Ida.
```{r}
Ida_Sewer <-  DEP_filter(DEP_points,"2021-08-16","2021-09-15") 
Sandy_Sewer <- DEP_filter(DEP_points,"2012-10-15","2012-11-14")
Henri_Sewer <-DEP_filter(DEP_points,"2021-08-06","2021-09-05")
Isaias_Sewer <- DEP_filter(DEP_points,"2020-07-18","2020-08-17")
Irene_Sewer <- DEP_filter(DEP_points,"2011-08-12","2011-09-11")

Sandy_timeseries <- time_plotting_series(Sandy_Sewer,"Sandy Timeframe")
Ida_timeseries <- time_plotting_series(Ida_Sewer,"Ida Timeframe")
Henri_timeseries <- time_plotting_series(Henri_Sewer,"Henri Timeframe")
Isaias_timeseries <- time_plotting_series(Isaias_Sewer,"Isaias Timeframe")
Irene_timeseries <- time_plotting_series(Irene_Sewer,"Irene Timeframe")

Sandy_timeseries
ggsave("../4_Outputs/1_Flooding/sandy_timeseries.jpeg")

Henri_timeseries
ggsave("../4_Outputs/1_Flooding/henri_timeseries.jpeg")

Ida_timeseries
ggsave("../4_Outputs/1_Flooding/ida_timeseries.jpeg")


```
```{r}
data_ida <- Ida_Sewer %>% group_by(complaint_type,date) %>% 
    count() %>% 
    st_drop_geometry() %>% 
    mutate(date = 1:30) %>% 
    rename(ida = n) %>% 
    select(-c(complaint_type))

data_sandy <- Sandy_Sewer %>% group_by(complaint_type,date) %>% 
    count() %>% 
    st_drop_geometry() %>% 
    mutate(date = 1:30) %>% 
    rename(sandy = n)%>% 
    select(-c(complaint_type))

data_isaias <- Isaias_Sewer %>% group_by(complaint_type,date) %>% 
    count() %>% 
    st_drop_geometry() %>% 
    mutate(date = 1:30) %>% 
    rename(isaias = n)%>% 
    select(-c(complaint_type))

data_henri <- Henri_Sewer %>% group_by(complaint_type,date) %>% 
    count() %>% 
    st_drop_geometry() %>% 
    mutate(date = 1:30) %>% 
    rename(henri = n)%>% 
    select(-c(complaint_type))

data_irene <- Irene_Sewer %>% group_by(complaint_type,date) %>% 
    count() %>% 
    st_drop_geometry() %>% 
    mutate(date = 1:30) %>% 
    rename(irene = n)%>% 
    select(-c(complaint_type))

combined <- data_ida %>% 
    left_join(data_sandy, by = c("date")) %>% 
    left_join(data_irene, by = c("date")) %>% 
    pivot_longer(cols = c("irene","ida","sandy"),names_to = "storm")

Combined <- ggplot(combined, aes(x = date)) +
    geom_line(aes(y = value, color = storm)) +
    scale_color_viridis(discrete = TRUE, direction = -1) +
    theme_minimal() +
    xlab("Days") +
    ylab("Sewer Complaints") 
Combined
ggsave("../4_Outputs/2_FEMA_Charts//Combined.pdf")

# ggplot(economics, aes(x=date)) + 
#   geom_line(aes(y = psavert), color = "darkred") + 
#   geom_line(aes(y = uempmed), color="steelblue", linetype="twodash") 

```


We can obtain a contour map of the three storms to see where complaints were most concentrated.
```{r}

Ida_sewer_contour <- st_kde(Ida_Sewer) %>% 
    st_get_contour(cont = c(10,20,30,40,50,60,70,80,90,100))

Sandy_sewer_contour <- st_kde(Sandy_Sewer) %>% 
    st_get_contour(cont = c(10,20,30,40,50,60,70,80,90,100))

Henri_sewer_contour <- st_kde(Henri_Sewer) %>% 
    st_get_contour(cont = c(10,20,30,40,50,60,70,80,90,100))

```

Comparing the complaints of Ida
```{r}
ida_contour <- tm_shape(boroughs, unit = "imperial")+
    tm_fill()+
    tm_shape(Ida_sewer_contour,bbox = st_bbox(Ida_sewer_contour))+    
    tm_fill(title = "Percentile","contlabel", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Ida Sewer Complaint Density",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(ida_contour,"../4_Outputs/1_Flooding/ida_contour.pdf")

ida_damage_pc <- tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Count of Damaged Buildings per Capita","dmgd_d_", 
            palette = "PuBu", lwd = .01,alpha = .5,
            style = "jenks") +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Ida FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(ida_damage_pc,"../4_Outputs/1_Flooding/ida_damage_pc.pdf")

ida_damage <- tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Count of Damaged Buildings","damgd_d", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Ida FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)
tmap_save(ida_damage,"../4_Outputs/1_Flooding/ida_damage.pdf")
```
Comparing the complaints of Sandy
```{r}
sandy_contour <- tm_shape(boroughs, unit = "imperial")+
    tm_fill()+
    tm_shape(Sandy_sewer_contour,bbox = st_bbox(Sandy_sewer_contour))+    
    tm_fill(title = "Percentile","contlabel", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Sandy Sewer Complaint Density",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(sandy_contour,"../4_Outputs/1_Flooding/sandy_contour.pdf")

sandy_damage_pc <-tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Counted Damaged Buildings per Capita","dmgd_s_", 
            palette = "PuBu", lwd = .01,alpha = .5,
            style = "jenks") +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Sandy FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(sandy_damage_pc,"../4_Outputs/1_Flooding/sandy_damage_pc.pdf")

sandy_damage<- tm_shape(NYC_FEMA_damage_Spatial, unit = "imperial")+
    tm_fill(title = "Count of Damaged Buildings","dmgd_sn", 
            palette = "PuBu", lwd = .01,alpha = .5) +
    tm_compass(size = .8) +
    tm_scale_bar(text.size = .5)+
    tm_layout(title = "Sandy FEMA Recorded Damages",
              title.size = 1,
              bg.color = "darkgrey", 
              frame = FALSE)

tmap_save(sandy_damage,"../4_Outputs/1_Flooding/sandy_damage.pdf")

```

```{r}
ida_zip <- Ida_Sewer %>% 
    group_by(incident_zip) %>% 
    count() %>% 
    ungroup() %>% 
    rename(ida_complaints = n)

sandy_zip <- Sandy_Sewer %>% 
    group_by(incident_zip) %>% 
    count() %>% 
    ungroup() %>% 
    rename(sandy_complaints = n)

combined_all <- zips %>% 
    merge(ida_zip %>%  st_drop_geometry, by.x = "ZIPCODE", by.y="incident_zip")%>%
    merge(sandy_zip%>%  st_drop_geometry, by.x = "ZIPCODE", by.y="incident_zip")%>%
    merge(NYC_FEMA_damage_Spatial %>%  st_drop_geometry, by.x = "ZIPCODE", by.y="ZIPCODE")%>%
    dplyr::select(c("ZIPCODE","PO_NAME","POPULATION","COUNTY","ida_complaints","sandy_complaints",
             "dmgd_sn","damgd_d","dmgd_s_","dmgd_d_")) %>% 
    mutate(ida_comp_q = ntile(ida_complaints/POPULATION, n = 5),
           ida_comp_q = coalesce(ida_comp_q, 0),
           sandy_comp_q = ntile(sandy_complaints/POPULATION, n = 5),
           sandy_comp_q = coalesce(sandy_comp_q, 0),
           ida_damg_q = ntile(dmgd_d_, n = 5),
           ida_damg_q = coalesce(ida_damg_q, 0),
           sandy_damg_q = ntile(dmgd_s_, n = 5),
           sandy_damg_q = coalesce(sandy_damg_q, 0),
           ida_composite = ifelse(ida_comp_q - ida_damg_q<0,0,ida_comp_q - ida_damg_q),
           sandy_composite= ifelse(sandy_comp_q - sandy_damg_q<0,0,sandy_comp_q - sandy_damg_q)) %>% 
    st_transform(crs = 3857)

ida_composite <- final_plotting(combined_all,"Ida Composite Score","ida_composite")
ida_damage <- final_plotting(combined_all,"Ida Complaints Score","ida_comp_q")
ida_complaints <- final_plotting(combined_all,"Ida Damages Score","ida_damg_q")


sandy_composite <- final_plotting(combined_all,"Sandy Composite Score","sandy_composite")
sandy_damage <- final_plotting(combined_all,"Sandy Complaints Score","sandy_comp_q")
sandy_complaints <- final_plotting(combined_all,"Sandy Damages Score","sandy_damg_q")

ida_composite
ida_damage
ida_complaints
sandy_composite
sandy_damage
sandy_complaints
# damage_raster = st_rasterize(NYC_FEMA_damage_Spatial)
# plot(damage_raster)
# 
# damage_raster = st_rasterize(NYC_FEMA_damage_Spatial)
# plot(damage_raster)
# 
# ida_raster <- Ida_Sewer %>% group_by(,date) %>% 
#     count() %>% 
#     st_drop_geometry() %>% 
#     mutate(date = 1:30) %>% 
#     rename(ida = n) %>% 
#     select(-c(complaint_type))
# 
# data_sandy <- Sandy_Sewer %>% group_by(complaint_type,date) %>% 
#     count() %>% 
#     st_drop_geometry() %>% 
#     mutate(date = 1:30) %>% 
#     rename(sandy = n)%>%
```

Choose the Zip Codes for a zoom in:

```{r}
	
ozone_park_zip <- c("11420")
forest_hills_zip <- c("11375")
flushing_zip <- c("11367")

zipcode_analysis(ozone_park_zip,combined_all,Ida_Sewer,"Ozone Park During Ida",2000)
zipcode_analysis(forest_hills_zip,combined_all,Sandy_Sewer,"Forest Hils During Sandy",2000)
zipcode_analysis(flushing_zip,combined_all,Sandy_Sewer,"Flushing During Sandy",2000)
```


